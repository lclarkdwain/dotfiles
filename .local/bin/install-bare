#!/bin/bash

set -o errexit
export GIT_WORK_TREE="$HOME"
export GIT_DIR="$GIT_WORK_TREE/.dotfiles"
backupdir="$GIT_WORK_TREE/dotfiles.bak"
repository="https://github.com/lclarkdwain/dotfiles.git"
exclude=(".editorconfig" ".gitignore" "Makefile" "README.md" "install.sh" ".local" "home")

function clone() {
  git clone --bare "$repository" "$GIT_DIR"
}

function backup() {
  for file in $(git ls-tree -r --name-only HEAD); do
    if [[ -e "$file" ]]; then
      mkdir -p "$backupdir"
      mv "$file" "$backupdir"
    fi
  done
}

function install() {
  git checkout
  git config status.showUntrackedFiles no
  git config core.worktree "$GIT_WORK_TREE"
  git sparse-checkout set "*" "${exclude[@]/#/\!}" --no-cone

  if [ -f "$HOME/.bashrc" ]; then
    cp "$HOME/.bashrc" "$HOME/.bashrc.bak"
  fi

  touch .bashrc
  echo "alias dotfiles='git --git-dir=$HOME/.dotfiles --work-tree=$HOME'" >>.bashrc
}

clone
backup
install
